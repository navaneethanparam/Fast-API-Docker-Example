name: Push Docker Image
# This workflow is triggered on any pull request
on:
    pull_request:
        branches:
            - main  # Or whatever your main branch is called
    push:
        branches:
            - main  # Or whatever your main branch is called
jobs:
    build-and-test:
        # The workflow will run on the latest Ubuntu virtual machine
        runs-on: ubuntu-latest

        steps:
            # 1. Checks out your repository code so the workflow can access it
            -   name: Check out repository
                uses: actions/checkout@v4

            # 2. Sets up a specific version of Python
            -   name: Set up Python
                uses: actions/setup-python@v5
                with:
                    python-version: '3.10' # You can change this to your desired Python version

            # 3. Installs dependencies
            # We need 'pytest' to run the tests
            -   name: Install dependencies
                run: |
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt # <-- UPDATED: Now reads from requirements.txt

            # 4. Runs the tests
            # This command will automatically find and run the 'test_main.py' file
            -   name: Run tests with pytest
                run: |
                    pytest

    push-to-repo:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout Code
                uses: actions/checkout@v3
            -   name: Login to Docker Hub
                uses: docker/login-action@v2 
                with:
                    username: ${{secrets.DOCKER_USERNAME}}
                    password: ${{secrets.DOCKER_PASS_TOKEN}}
            -   name: Build and Push
                uses: docker/build-push-action@v4
                with:
                    context: .
                    push: true
                    tags: imarty/fast-api-docker-example:latest